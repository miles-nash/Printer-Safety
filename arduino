/*
Printer Safety Gadget Arduino code
Updated code can be found on https://github.com/miles-nash/Printer-Safety/tree/master
A full tutorial and more information can be found on https://www.hackster.io/Milesnash_/3d-printer-fire-safety-448acf
The goal of this project was to create a device that allows 3d printer owners to  feel comftorable leaving their 3d printers running unsuppervised
It also decreases the likelyhood of an out of control electrical fire and can help to decrease damage.
 
 This work is licensed under the
 Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License.
 To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-sa/3.0/
 or send a letter to Creative Commons, 444 Castro Street, Suite 900,
 Mountain View, California, 94041, USA.
*/
int time1 = 280;
int time2 = 40;
int time3 = 9680;
int ledSensePin = 11; //led turns on and off the 
int sensorPin = 5;
int alarmPin = 8;
int ledPin = 12;
float voltage,voltageCalc,airQuality = 0;
bool hazard = false;
int hazardDelay = 10000000000; //The time in milliseconds until the alarm stops
int lastHazard;
int relay1 = 10;
int relay2 = 9;
int triggerNumber = 400; //Sensor output required to set off alarm and kill power
void setup() {
  Serial.begin(9600);
  pinMode(ledSensePin,OUTPUT);
  pinMode(alarmPin,OUTPUT);
  pinMode(relay1,OUTPUT);
  pinMode(relay2,OUTPUT);
  digitalWrite(relay1,LOW); //the relay linked on github is activated by LOW
  digitalWrite(relay2,LOW);//turn on printer
}

void loop() {
  //Adapted from a sketch by Cyrille MÃ©dard de Chardon (serialC), Christophe Trefois (Trefex)
  //http://arduinodev.woofex.net/2012/12/01/standalone-sharp-dust-sensor/ 
 ///////////////////////////////////////////////////////////// 
  digitalWrite(ledSensePin, LOW); //turn on sensor
  delayMicroseconds(time1);
  voltage = analogRead(sensorPin);
  delayMicroseconds(time2);
  digitalWrite(ledSensePin, HIGH); //turn off sensor
  delayMicroseconds(time3);
  Serial.println(voltage);
 ///////////////////////////////////////////////////////////// 
  if(voltage >= triggerNumber){//if the voltage coming from the sensor is t0o high, a hazard is present
    hazard = true;
    lastHazard = millis();
  }

  if(voltage < triggerNumber - 50 && (millis() - lastHazard) > hazardDelay){//if the hazard stops and a time has passed, stop alarm
    hazard = false;
  }

  if(hazard == true){
    //relay
    digitalWrite(relay1,HIGH); //disigage relay: Turn off printer ect.
    digitalWrite(relay2,HIGH); // must reset safety host to turn on printer
    tone(alarmPin, 100);//alarm sequence
    digitalWrite(ledPin,HIGH);
    delay(1000);
    noTone(alarmPin);
    digitalWrite(ledPin,LOW);
    delay(1000);
     tone(alarmPin, 100);
     digitalWrite(ledPin,HIGH);
    delay(1000);
    noTone(alarmPin);
    digitalWrite(ledPin,LOW);
    delay(1000);
     tone(alarmPin, 100);
     digitalWrite(ledPin,HIGH);
    delay(1000);
    noTone(alarmPin);
    digitalWrite(ledPin,LOW);
    delay(1000*2);
  }
  delay(1000);
}
